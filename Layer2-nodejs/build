#!/bin/bash

# This script prepares a minimally functional linux system with
# absolutely nothing aside from the userland C++ libraries
# necessary to really call yourself linux

NODE_VERSION=v0.10.21

if [[ -z "$name" ]]; then
  echo "Please Specify an Image Name"
  echo "e.g. '${SUDO}name=layer2 $0 $@'"
  exit 5
fi

if [[ -e "$SUDO_COMMAND" ]]; then SUDO="sudo "; fi

# The root directory *must not* be a special mount,
# such as /vagrant or an nfs directory
if [[ -z $ROOT ]]; then
  ROOT=/tmp/ROOT
fi

# explicicly clone node because submodules SUCK
if [[ ! -d deps/node ]]; then
  git clone https://github.com/joyent/node.git deps/node &&
  ( # configure node only once at checkout
    cd deps/node               &&
    git checkout $NODE_VERSION &&
    ./configure --fully-static
  ) || err 6
fi

make default || exit 10

# Important shared libraries
if [ $(uname -m) == 'x86_64' ]; then
  platform=x86_64-linux-gnu

  mkdir -p $ROOT/lib64                                                &&
  ln -s /lib/$platform/ld-linux.so.2 $ROOT/lib64/ld-linux-x86-64.so.2 || exit 90
else
  platform=i386-linux-gnu
fi

mkdir -p $ROOT/lib/$platform                                 &&
cp    -f /lib/$platform/libpthread.so.0 $ROOT/lib/$platform/ || exit 100


if [[ -n "$QEMU" ]]; then
  sudo cp deps/node/node $ROOT/usr/bin/node
else
  docker build -t $name . || exit 11
fi

echo "Successfully built Layer-2 image '$name'"
echo "To View Image : ${SUDO}docker images"
echo "To Cleanup    : make clean"
