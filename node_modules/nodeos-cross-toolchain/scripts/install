#!/usr/bin/env bash

# This script compiles from scratch a Node.js executable and its needed
# libraries and shell utils to offer a Node.js REPL from cold boot

set +h
umask 022
LC_ALL=POSIX

GRN="\e[32m"
CLR="\e[0m"


NUM_JOBS=$((`nproc` + 1))

if [[ -z "$CPU" ]]; then
#  CPU=$(uname -m);  # [ToDo] Detect platform CPU
  CPU=ia32
fi

case $CPU in
  arm)
    TARGET=arm-nodeos-linux
  ;;
  ia32)
    TARGET=i686-nodeos-linux
  ;;
  x64)
    TARGET=x86_64-nodeos-linux
  ;;
  *)
    exit 100
  ;;
esac

LFS=`pwd`
SOURCES=`pwd`/sources
#TOOLS=`pwd`/tools
TOOLS=/tools
OBJECTS=`pwd`/obj/$CPU
PATH=$TOOLS/bin:/bin:/usr/bin

MAKE="make --jobs=$NUM_JOBS"

export LC_ALL NUM_JOBS CPU TARGET LFS SOURCES OBJECTS TOOLS PATH MAKE


scripts/install-pass1.sh &&
scripts/install-pass2.sh || exit $?


echo -e "${GRN}Successfully built cross-toolchain for '$CPU'${CLR}"
