#!/usr/bin/env bash

#
# binutils
#

SRC_DIR=$SOURCES/binutils
OBJ_DIR=$OBJECTS/binutils

# Configure & compile
if [[ ! -d $OBJ_DIR ]]; then
  mkdir -p $OBJ_DIR &&
  (
    cd $OBJ_DIR                    &&
    $SRC_DIR/configure             \
        --prefix=$TOOLS            \
        --with-sysroot=$LFS        \
        --with-lib-path=$TOOLS/lib \
        --target=$TARGET           \
        --disable-nls              \
        --disable-werror           &&
    $MAKE
  ) || exit 100

  case $(uname -m) in
    x86_64)
      mkdir -v $TOOLS/lib && ln -sv lib $TOOLS/lib64
    ;;
  esac
fi

# Install
( cd $OBJ_DIR && $MAKE install ) || exit 101


#
# gcc
#

SRC_DIR=$SOURCES/gcc
OBJ_DIR=$OBJECTS/gcc

# Configure & compile
if [[ ! -d $OBJ_DIR ]]; then
  mkdir -p $OBJ_DIR &&
  (
    cd $OBJ_DIR                                        &&
    $SRC_DIR/configure                                 \
        --target=$TARGET                               \
        --prefix=$TOOLS                                \
        --with-sysroot=$LFS                            \
        --with-newlib                                  \
        --without-headers                              \
        --with-local-prefix=$TOOLS                     \
        --with-native-system-header-dir=$TOOLS/include \
        --disable-nls                                  \
        --disable-shared                               \
        --disable-multilib                             \
        --disable-decimal-float                        \
        --disable-threads                              \
        --disable-libatomic                            \
        --disable-libgomp                              \
        --disable-libitm                               \
        --disable-libquadmath                          \
        --disable-libsanitizer                         \
        --disable-libssp                               \
        --disable-libvtv                               \
        --disable-libcilkrts                           \
        --disable-libstdc++-v3                         \
        --enable-languages=c,c++
    $MAKE
  ) || exit 110
fi

# Install
( cd $OBJ_DIR && $MAKE install ) || exit 111


#
# glibc
#

SRC_DIR=$SOURCES/libc
OBJ_DIR=$OBJECTS/libc

LINUX_VERSION=$(cd $SOURCES/linux; make kernelversion)

# Configure & compile
if [[ ! -d $OBJ_DIR ]]; then
  mkdir -p $OBJ_DIR &&
  (
    cd $OBJ_DIR                                &&
    $SRC_DIR/configure                         \
      --prefix=$TOOLS                          \
      --host=$TARGET                           \
      --build=$($SRC_DIR/scripts/config.guess) \
      --disable-profile                        \
      --disable-sanity-checks                  \
      --enable-kernel=$LINUX_VERSION           \
      --with-headers=$TOOLS/include            \
      libc_cv_forced_unwind=yes                \
      libc_cv_ctors_header=yes                 \
      libc_cv_c_cleanup=yes                    &&
    $MAKE
  ) || exit 120
fi

# Install
( cd $OBJ_DIR && $MAKE install ) || exit 121


#
# Check basic functions (compiling and linking) works as expected
#

echo 'main(){}' > dummy.c          || exit 130
$TARGET-gcc dummy.c                || exit 131
readelf -l a.out | grep ': '$TOOLS || exit 132
rm -v dummy.c a.out                || exit 133


echo -e "${GRN}Successfully built cross-toolchain pass 1${CLR}"
