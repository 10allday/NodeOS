#!/usr/bin/env bash

SOURCES=`pwd`/sources
TOOLS=`pwd`/tools


# Dependencies versions

BINUTILS_VERSION=2.24
GCC_VERSION=4.9.2
LINUX_VERSION=3.18.1
GLIBC_VERSION=2.20


# Dependencies URLs

BINUTILS_URL=http://ftpmirror.gnu.org/binutils/binutils-$BINUTILS_VERSION.tar.gz
GCC_URL=http://ftpmirror.gnu.org/gcc/gcc-$GCC_VERSION/gcc-$GCC_VERSION.tar.gz
LINUX_URL=https://www.kernel.org/pub/linux/kernel/v3.x/linux-$LINUX_VERSION.tar.xz
GLIBC_URL=http://ftpmirror.gnu.org/glibc/glibc-$GLIBC_VERSION.tar.xz


#
# binutils
#

SRC_DIR=$SOURCES/binutils
if [[ ! -d $SRC_DIR ]]; then
  mkdir -p $SRC_DIR                                                  &&
  curl -L $BINUTILS_URL | tar xzf - -C $SRC_DIR --strip-components=1 || exit 10
fi


#
# gcc
#

SRC_DIR=$SOURCES/gcc
if [[ ! -d $SRC_DIR ]]; then
  mkdir -p $SRC_DIR                                             &&
  curl -L $GCC_URL | tar xzf - -C $SRC_DIR --strip-components=1 &&
  (
    cd $SRC_DIR

    # Download source code of mpfr, gmp & mpc
#    contrib/download_prerequisites
    mkdir -p mpfr && curl -L http://www.mpfr.org/mpfr-current/mpfr-3.1.2.tar.xz | tar xJf - -C mpfr --strip-components=1 &&
    mkdir -p gmp  && curl -L https://gmplib.org/download/gmp/gmp-6.0.0a.tar.xz  | tar xJf - -C gmp  --strip-components=1 &&
    mkdir -p mpc  && curl -L ftp://ftp.gnu.org/gnu/mpc/mpc-1.0.2.tar.gz         | tar xzf - -C mpc  --strip-components=1 || exit 20

    #########################################################################
    # Here will be dragons. Should't it be included in GCC ./configure? :-( #
    #########################################################################
    for file in \
     $(find gcc/config -name linux64.h -o -name linux.h -o -name sysv4.h)
    do
      cp -uv $file{,.orig}
      sed -e 's@/lib\(64\)\?\(32\)\?/ld@/tools&@g' \
          -e 's@/usr@/tools@g' $file.orig > $file
      echo '
#undef STANDARD_STARTFILE_PREFIX_1
#undef STANDARD_STARTFILE_PREFIX_2
#define STANDARD_STARTFILE_PREFIX_1 "/tools/lib/"
#define STANDARD_STARTFILE_PREFIX_2 ""' >> $file
      touch $file.orig
    done

    sed -i '/k prot/agcc_cv_libc_provides_ssp=yes' gcc/configure

    sed -i 's/if \((code.*))\)/if (\1 \&\& \!DEBUG_INSN_P (insn))/' gcc/sched-deps.c
    #########################################################################
  ) || exit 21
fi


#
# Linux kernel headers
#

SRC_DIR=$SOURCES/linux
if [[ ! -d $SRC_DIR ]]; then
  mkdir -p $SRC_DIR                                               &&
  curl -L $LINUX_URL | tar xJf - -C $SRC_DIR --strip-components=1 &&
  (
    cd $SRC_DIR

    # Extract headers
    make mrproper                              &&
    make INSTALL_HDR_PATH=dest headers_install &&
    mkdir -p $TOOLS/include                    &&
    cp -rv dest/include/* $TOOLS/include
  ) || exit 30
fi


#
# glibc
#

SRC_DIR=$SOURCES/libc
if [[ ! -d $SRC_DIR ]]; then
  mkdir -p $SRC_DIR                                               &&
  curl -L $GLIBC_URL | tar xJf - -C $SRC_DIR --strip-components=1 || exit 40
fi

# Check system headers
if [[ ! -r /usr/include/rpc/types.h ]]; then
  su -c 'mkdir -pv /usr/include/rpc'
  su -c 'cp -v sunrpc/rpc/*.h /usr/include/rpc'
fi
