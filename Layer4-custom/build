#!/bin/bash

# This script prepares the users filesystem


if [[ -z "$name" ]]; then name=layer4; fi


case $PLATFORM in
  docker)
    USERS=$(pwd)/USERS
  ;;
  qemu)
    USERS=/tmp/USERS
  ;;
esac


HOME=$USERS/root

mkdir -p $HOME || exit 40


# Install /root dependencies from NPM using Ubuntu

NODE_DIR=`pwd`/../Layer2-nodejs/deps/node
NPM="$NODE_DIR/node $NODE_DIR/deps/npm/cli.js"
npmi="npm_config_prefix=$HOME $NPM i -g"

eval $npmi `cat packages.txt` || exit 41


case $PLATFORM in
  docker)
    docker build -t $name . || exit 42
  ;;
  qemu)
    qemu-img create -f raw $name.img 32M
    mkfs.ext4 -F $name.img

    mkdir /tmp/usersfs
    sudo mount -o loop $name.img /tmp/usersfs

    # sudo mkdir /mnt/rootfs/boot
    # sudo cp vmlinuz /mnt/rootfs/boot/vmlinuz
    # sudo cp initrd /mnt/rootfs/boot/initrd

    sudo cp -R $USERS/* /tmp/usersfs

    sudo umount /tmp/usersfs
    rm -r /tmp/usersfs
  ;;
esac

echo "Successfully built Layer-4 image '$name'"
